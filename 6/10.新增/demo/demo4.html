<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>动态埋点统计示例</title>
  <style type="text/css">
    #div1 {
      width: 300px;
      height: 200px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    #div2 {
      height: 800px;
      width: 300px;
      background-color: #ddd;
      overflow: hidden;
      padding: 200px 0;
    }

    .partItem {
      margin-top: 50px;
      width: 70px;
      height: 70px;
      background-color: pink;
    }
  </style>
</head>
<body>
<div id="div1">
  <div id="div2">
    <div class="partItem partItem1">1</div>
    <div class="partItem partItem2">2</div>
    <div class="partItem partItem3">3</div>
    <div class="partItem partItem4">4</div>
    <div class="partItem partItem5">5</div>
    <div class="partItem partItem6">6</div>
    <div class="partItem partItem7">7</div>
    <div class="partItem partItem8">8</div>
  </div>
</div>
<script type="text/javascript">
    console.log('%c 元素观察器监听封装：', 'font-size:30px;color:red;');

    // 开始观察
    /**
     *
     */
    watchExposure(document.querySelectorAll("#div2 .partItem"), function (res) {
        // todo
      console.log('成功回调:', res);
    }, {
      ratio: 0.1,
      poll: 50,
    });


    /**
     * 元素观察器监听
     *
     * @param elements 元素伪数组（必填）；
     * 例如：document.querySelectorAll("#div2 .partItem")；
     *
     * @param callback 成功回调（非必填）；
     * 返回值：visibility：是否显示
     *       item：监听dom节点信息；
     *
     * @param options  配置参数（非必填）；
     * ratio：显示/隐藏比例，默认值：0.5；poll：节流时间，50ms；
     *
     * 调用示例：
     * watchExposure(document.querySelectorAll("#div2 .partItem"), function (res) {
          console.log('成功回调:', res);
          }, {
          ratio: 0.1,
          poll: 50,
      });
     */
    function watchExposure (elements, callback, options = {}) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((item) => {
                if (item.intersectionRatio >= (options.ratio || 0.5)) {
                    // console.log(item.target.getAttribute('idx'));
                    // console.log(item.target.innerHTML, '显示', item.intersectionRatio);
                    callback && callback({
                      index: Number(item.target.getAttribute('idx')),
                      visibility: true,
                      item
                    });
                } else {
                  // console.log(item.target.getAttribute('idx'));
                  // console.log(item.target.innerHTML, '不显示', item.intersectionRatio);
                  callback && callback({
                    index: Number(item.target.getAttribute('idx')),
                    visibility: false,
                    item
                  });
                }
            });
        }, {
            threshold: [options.ratio || 0.5] // 一个包含阈值的列表, 按升序排列, 列表中的每个阈值都是监听对象的交叉区域与边界区域的比率。
        });

        observer.POLL_INTERVAL = (options.poll || 50); // 节流时间为50毫秒

        Array.from(elements).forEach((el, idx) => {
          el.setAttribute('idx', idx);
          return observer.observe(el)
        });
    }
</script>
</body>
</html>