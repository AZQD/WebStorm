<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>音悦台-Myself</title>
    <link href="img/logo.jpg" rel="shortcut icon" type="image/x-icon"/>
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <section class="wrap">
        <header id="header">
            <div class="headerT">
                <h1 id="logo">
                    <a href="javascript:void(0);">
                        <img src="img/logo.png" alt="">
                    </a>
                </h1>
                <a href="javascript:void(0);" id="menu" class="menuClose"></a>
                <div id="btns">
                    <a href="javascript:void(0);" class="search">搜索</a>
                    <a href="javascript:void(0);">登录</a>
                    <a href="javascript:void(0);">注册</a>
                </div>
            </div>
            <form id="search">
                <input type="text" placeholder="请输入搜索内容">
                <input type="submit" value="提交">
            </form>

            <!--头部的列表-->
            <ul id="nav">
                <!--<li><a href="http://www.baidu.com">首页</a></li>-->
                <li><a href="javascript:void(0);">首页</a></li>
                <li><a href="javascript:void(0);">MV</a></li>
                <li><a href="javascript:void(0);">悦单</a></li>
                <li><a href="javascript:void(0);">V榜</a></li>
                <li><a href="javascript:void(0);">音悦</a></li>
                <li><a href="javascript:void(0);">商城</a></li>
                <li><a href="javascript:void(0);">节目</a></li>
                <li><a href="javascript:void(0);">饭团</a></li>
                <li><a href="javascript:void(0);">资讯</a></li>
                <li><a href="javascript:void(0);">我的家</a></li>
                <li><a href="javascript:void(0);">APP下载</a></li>
                <li><a href="javascript:void(0);">热门应用</a></li>
            </ul>
        </header>
        <section id="content">
            <!--导航-->
            <div id="navScroll">
                <ul id="navs">
                    <li class="active"><a href="javascript:void(0);">首页</a></li>
                    <li><a href="javascript:void(0);">MV</a></li>
                    <li><a href="javascript:void(0);">悦单</a></li>
                    <li><a href="javascript:void(0);">V榜</a></li>
                    <li><a href="javascript:void(0);">商城</a></li>
                    <li><a href="javascript:void(0);">众筹</a></li>
                    <li><a href="javascript:void(0);">饭团</a></li>
                    <li><a href="javascript:void(0);">节目</a></li>
                    <li><a href="javascript:void(0);">音悦stage</a></li>
                    <li><a href="javascript:void(0);">app下载</a></li>
                    <li><a href="javascript:void(0);">资讯</a></li>
                    <li><a href="javascript:void(0);">我的家</a></li>
                    <li><a href="javascript:void(0);">热门应用</a></li>
                </ul>
            </div>

            <!--轮播-->
            <div id="wrapImg">
                <ul id="listImg">
                    <li>
                        <a href="javascript:void(0)">
                            <img src="img/1.jpg"/>
                        </a>
                    </li>
                    <li>
                        <a href="javascript:void(0)">
                            <img src="img/2.jpg"/>
                        </a>
                    </li>
                    <li>
                        <a href="javascript:void(0)">
                            <img src="img/3.jpg"/>
                        </a>
                    </li>
                    <li>
                        <a href="javascript:void(0)">
                            <img src="img/4.jpg"/>
                        </a>
                    </li>
                    <li>
                        <a href="javascript:void(0)">
                            <img src="img/5.jpg"/>
                        </a>
                    </li>
                    <li>
                        <a href="javascript:void(0)">
                            <img src="img/6.jpg"/>
                        </a>
                    </li>
                </ul>
                <div id="navImg">
                    <span class="active"></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!--选项卡-->
            <section class="tab">
                <div class="tabHeader">
                    <h2>MV首播</h2>
                    <a href="###">更多&gt;</a>
                </div>
                <nav class="tabNav">
                    <a href="###">全部</a>
                    <a href="###">内地</a>
                    <a href="###">港台</a>
                    <a href="###">欧美</a>
                    <a href="###">韩国</a>
                    <a href="###">日本</a>
                    <span></span>
                </nav>
                <section class="tabList">
                    <ul class="tabNext"></ul>
                    <ul class="tabShow">
                        <li>
                            <a href="###">
                                <img src="img/a.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/b.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/c.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/d.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/e.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/f.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                    </ul>
                    <ul class="tabNext"></ul>
                </section>
            </section>

            <!--选项卡-->
            <section class="tab">
                <div class="tabHeader">
                    <h2>MV首播</h2>
                    <a href="###">更多&gt;</a>
                </div>
                <nav class="tabNav">
                    <a href="###">全部</a>
                    <a href="###">内地</a>
                    <a href="###">港台</a>
                    <a href="###">欧美</a>
                    <a href="###">韩国</a>
                    <a href="###">日本</a>
                    <span></span>
                </nav>
                <section class="tabList">
                    <ul class="tabNext"></ul>
                    <ul class="tabShow">
                        <li>
                            <a href="###">
                                <img src="img/a.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/b.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/c.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/d.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/e.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                        <li>
                            <a href="###">
                                <img src="img/f.jpg" alt="">
                                <span>Move</span>
                            </a>
                        </li>
                    </ul>
                    <ul class="tabNext"></ul>
                </section>
            </section>
        </section>
    </section>
    <script type="text/javascript" src="js/draft.js"></script>
    <script type="text/javascript">
        //定义字体的函数
        setRem();
        window.addEventListener('onorientationchange' in window?'orientationchange':'resize', function(){
            setRem();
        },false);

        function setRem (){ //重置字体rem
            var html = document.querySelector('html');
            var width = html.getBoundingClientRect().width;
            console.log('html.getBoundingClientRect().width=' + html.getBoundingClientRect().width);
            html.style.fontSize = width/16 + 'px';
            console.log('html.style.fontSize='+html.style.fontSize);
        }

        /*document.addEventListener('click', function(ev){
            ev = ev || event;
            ev.preventDefault();
        }, false);*/

        toggleMenu();
        function toggleMenu(){
            var menuEl = document.querySelector('#menu');
            var navEl = document.querySelector('#nav');
            /*点击显示/隐藏menu*/
            menuEl.addEventListener('touchstart', function(ev){
                if(this.className == 'menuClose'){
                    this.className = 'menuOpen';
                    navEl.style.display = 'block';
                }else{
                    this.className = 'menuClose';
                    navEl.style.display = 'none';
                }
                ev.stopPropagation();
            }, false);

            /*点击document的其他位置，隐藏menu*/
            document.addEventListener('touchstart', function(){
                if(menuEl.className == 'menuOpen'){
                    menuEl.className = 'menuClose';
                    navEl.style.display = 'none';
                }
            }, false);

            /*点击显示的ul列表时，取消冒泡。*/
            navEl.addEventListener('touchstart', function(ev){
                ev.stopPropagation();
            },false);
        }

        //可拖拽的导航
        dragNav();
        function dragNav(){
            var navScroll = document.querySelector('#navScroll');
            var navs = document.querySelector('#navs');
            var startpoint = 0; //定义手指初始化位置
            var startX = 0;  //定义ul的初始位置

            var minX = navScroll.clientWidth - navs.offsetWidth;
            //定义手指滑动距离与ul移动距离的一个比例
            var flag = 1;

            var lastDis = 0; //上一次的位置
            var lastTime = 0; //上一次的时间值
            var disVal = 0; //距离的差值
            var disTime = 0; //时间的差值
            navScroll.addEventListener('touchstart', function(ev){
                startpoint = ev.changedTouches[0].clientX;
                startX = cssTransform(navs, 'translateX');

                lastDis = startX;
                lastTime = new Date().getTime();
                disVal = 0;
                disTime = 0;

            }, false);

            navScroll.addEventListener('touchmove', function(ev){
                var nowpoint = ev.changedTouches[0].clientX;
                var dis = nowpoint - startpoint;
                var translateX = startX + dis;

                var nowTime = new Date().getTime();

                if(translateX > 0){
                    //translateX = 0;
                    console.log('navScroll.clientWidth='+navScroll.clientWidth); //375
                    flag = 0.8 - translateX/(navScroll.clientWidth*2);
                    translateX = translateX * flag;
                }
                if(translateX < minX){
                    console.log('minX='+minX);
                    var over = minX - translateX;
                    flag = 0.8 - over/(navScroll.clientWidth*2);
                    translateX = minX - over*flag;
                }

                disVal = translateX - lastDis;
                disTime = nowTime - lastTime;
                lastDis = translateX;
                lastTime = nowTime;

                cssTransform(navs, 'translateX', translateX);
            }, false);

            navScroll.addEventListener('touchend', function(){
                var speed = disVal/disTime;
                var translateX = cssTransform(navs, 'translateX');
                var target = translateX + speed*300;
                var time = target*3;
                time = time<300?300:time;
                var bessel = '';
                if(target>0){
                    target = 0;
                    bessel = 'cubic-bezier(.12,.39,.61,1.75)';
                }
                if(target<minX){
                    target = minX;
                    bessel = 'cubic-bezier(.12,.39,.61,1.75)';
                }

                navs.style.transition = time + 'ms ' + bessel;
                cssTransform(navs, 'translateX', target);
            }, false);
        }

        carousel();
        function carousel(){
            /*document.addEventListener("touchstart",function(ev){
                        ev.preventDefault();
                    }
            );*/

            var css = document.createElement("style");
            document.head.appendChild(css);
            var wrap = document.querySelector("#wrapImg");
            var list = document.querySelector("#listImg");

            list.innerHTML += list.innerHTML;

            var lis = document.querySelectorAll("#listImg li");
            var nav = document.querySelectorAll("#navImg span");


            /*问题:
             1.ul拿的是父元素的100%--->一路往上找--->414px
             2.ul的宽度应该为414 * li的个数 才能在一行放下所有的li
             3.li应该设置为 (1/lis.length*100)%
             4.img的样式应该控制为 宽高自适应

             5.实现轮播效果,需要ul为绝对定位
             6.设置ul绝对定位后,wapper高度无法被撑开,需要js来控制
             wapper高度应与某一个li的高度一至
             */

            //需要等dom树渲染完之后执行
            setTimeout(function(){
                var style ="#listImg{width:"+lis.length+"00%;}";
                style+="#listImg li{width: "+(1/lis.length*100)+"%;}";
                style+="#wrapImg{height:"+lis[0].offsetHeight+"px;}";
                css.innerHTML+= style;
            }, 20);

            //开始滑屏
            var startpoint =0;
            var startX=0;
            //偏移量容器
            cssTransform(list,"translateX",0);
            var now=0;
            var clearTime =0;

            //判断是否为x轴滑动
            var isX = true;

            //判断是否为第一次
            var isFirst = true;

            wrap.addEventListener("touchstart",function(ev){
                clearInterval(clearTime);
                list.style.transition="none";


                if(now ==0){
                    now=nav.length;
                }
                if(now==lis.length-1){
                    now=nav.length-1
                }
                cssTransform(list,"translateX",-now*wrap.offsetWidth);


                var touch =ev.changedTouches[0];
                startpoint = touch;
                startX= cssTransform(list,"translateX");

                isX = true;
                ifFirst = true;

            });

            wrap.addEventListener("touchmove",function(ev){
                if(!isX){
                    return;
                }
                var touch =ev.changedTouches[0];
                var nowpoint=touch;
                var disX =nowpoint.clientX -startpoint.clientX;
                var disY =nowpoint.clientY -startpoint.clientY;

                if(isFirst){
                    ifFirst = false;
                    if(Math.abs(disY) > Math.abs(disX)){
                        isX = false;
                        return;
                    }
                }

                cssTransform(list,"translateX",startX + disX);
            });

            wrap.addEventListener("touchend",function(ev){
                var touch =ev.changedTouches[0];
                //标记当前哪一个li占据着视口

                now = Math.round(-cssTransform(list,"translateX")/wrap.offsetWidth);

                //限制超出
                if(now < 0){
                    now=0;
                }
                if(now>lis.length-1){
                    now=lis.length-1;
                }

                /*cssTransform(list,"translateX",-now*wrap.offsetWidth);
                 list.style.transition="1s";
                 for(var i=0;i<nav.length;i++){
                 nav[i].className="";
                 }
                 nav[now%nav.length].className="active";*/
                autoMove();
                auto();
            });


            //自动轮播
            auto();
            function auto(){
                clearTime =setInterval(function(){
                    if(now==lis.length-1){
                        list.style.transition="none";
                        now=nav.length-1;
                        cssTransform(list,"translateX",-now*wrap.offsetWidth);
                    }

                    setTimeout(function(){
                        now++;
                        autoMove();
                    },20);
                },2000);
            }

            function autoMove(){
                list.style.transition="1s";
                cssTransform(list,"translateX",-now*wrap.offsetWidth);

                for(var i=0;i<nav.length;i++){
                    nav[i].className="";
                }
                nav[now%nav.length].className="active";
            }
        }





        //可同步的选项卡
        tab();
        function tab(){
            var tabNav =document.querySelectorAll(".tabNav");
            var tabList =document.querySelectorAll(".tabList");
            var tabNext =document.querySelectorAll(".tabNext");

            var translateX = tabNav[0].offsetWidth;
            for(var i=0;i<tabNav.length;i++){
                swipe(tabList[i],tabNav[i]);
            }

            function swipe(list,nav){
                cssTransform(list,"translateX",-translateX);

                var startpoint =0;
                var startX=0;
                var isX =true;
                var isFirst =true;
                var isLoading = true;

                list.addEventListener("touchstart",function(ev){
                    if(!isLoading){
                        return;
                    }
                    list.style.transition="none";
                    var touch =ev.changedTouches[0];
                    startpoint = touch;
                    startX= cssTransform(list,"translateX");

                    isX =true;
                    isFirst = true;
                });

                list.addEventListener("touchmove",function(ev){
                    if(!isLoading){
                        return;
                    }
                    if(!isX){
                        return;
                    }

                    var touch =ev.changedTouches[0];
                    var nowpoint=touch;
                    var disX =nowpoint.clientX -startpoint.clientX;
                    var disY =nowpoint.clientY -startpoint.clientY;

                    if(isFirst){
                        isFirst = false;
                        if(Math.abs(disY)>Math.abs(disX)){
                            isX=false;
                            return;
                        }
                    }

                    cssTransform(list,"translateX",startX + disX);

                    if(Math.abs(disX)>translateX/2){
                        end(disX);
                    }
                });

                function end(disX){
                    isLoading=false;
                    var traget =disX>0?0:-2*translateX;
                    list.style.transition="300ms ";
                    cssTransform(list,"translateX",traget);
                    list.addEventListener("transitionend",transitionEnd);
                    list.addEventListener("webkitTransitionEnd",transitionEnd);
                }
                function transitionEnd(){
                    list.removeEventListener("transitionend",transitionEnd);
                    list.removeEventListener("webkitTransitionEnd",transitionEnd);
                    for(var i=0;i<tabNext.length;i++){
                        tabNext[i].style.opacity=1;
                    }
                    //发一个ajax请求
                    setTimeout(function(){
                        list.style.transition="none";
                        cssTransform(list,"translateX",-translateX);
                        isLoading=true;
                    },2000);
                }



                list.addEventListener("touchend",function(ev){
                    var touch =ev.changedTouches[0];
                    var nowpoint=touch;
                    var disX =nowpoint.clientX -startpoint.clientX;
                    if(Math.abs(disX)<translateX/2){
                        list.style.transition="300ms ";
                        cssTransform(list,"translateX",-translateX);
                    }

                });


            }
        }
    </script>
</body>
</html>